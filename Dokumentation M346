# Projekt M346 AWS

## Inhaltsverzeichniss
### **1. Einleitung*
#### 1.1Aufgabenstellung
#### 1.2 Ziele
#### 1.3 Was ist Nextcloud
#### 1.4 Aufgabenverteilung
### **2. Vorgehen**
#### 2.1 Planung
#### 2.2 Git-Repo aufsetzen
#### 2.3 Initial-scripts
#### 2.4 deploy.sh 
### **3. Testfälle**
#### 3.1 Testfall 1
#### 3.2 Testfall 2
#### 3.3 Testfall 3
### **4. Reflexion**
### **5. Quellen**
---
<br><br> 


# 1. Einleitung
## 1.1 Aufgabenstellung
In dieser Projektarbeit wird Nextcloud in der Community Edition installiert. Dafür wird die Archiv-Variante verwendet. Es wird bewusst kein Docker und kein Web Installer eingesetzt, damit der Installationsprozess Schritt für Schritt nachvollziehbar bleibt.

Der Datenbankserver wird auf einem separaten Server eingerichtet. Dieser Server wird so konfiguriert, dass er mit Nextcloud zusammenarbeiten kann. Dadurch sind die Anwendung und die Datenbank klar voneinander getrennt, wie es auch in vielen realen Cloud-Umgebungen der Fall ist.

Beim Aufruf der Nextcloud-URL soll im Webbrowser der Installationsassistent von Nextcloud erscheinen. Über diesen Assistenten wird die Anwendung fertig eingerichtet.

Die für die Installation benötigten Angaben zur Datenbankverbindung zum Beispiel Datenbankname, Benutzername und Passwort werden in der Konsole ausgegeben. Diese Informationen können anschliessend im Installationsassistenten eingetragen werden. Bei der Umsetzung werden die vorgegebenen Bewertungskriterien berücksichtigt.

<br><br>

## 1.2 Ziele:
In dieser Projektarbeit sollen mehrere wichtige Ziele erreicht werden. Der erste Schwerpunkt liegt auf der erfolgreichen Installation und dem Betrieb eines funktionierenden Cloud-Services. Dieser Service muss stabil laufen und alle Anforderungen erfüllen, die im weiteren Verlauf der Dokumentation beschrieben werden.

Ein weiteres Ziel besteht darin, den gesamten Service mithilfe von Infrastructure as Code umzusetzen. Dadurch soll die Installation jederzeit reproduzierbar sein und ohne grossen Aufwand erneut in einer Cloudumgebung gestartet werden können. Alle verwendeten Konfigurationsdateien werden in einer Versionsverwaltung abgelegt, damit jede Änderung klar nachvollziehbar bleibt.

Auch die Dokumentation spielt eine Rolle. Sie wird vollständig in Markdown erstellt und im gleichen Git-Repository wie die Konfigurationsdateien abgelegt. So bleibt die gesamte Projektarbeit übersichtlich strukturiert und an einem Ort verbunden.

Ein zusätzliches Ziel ist die Durchführung verschiedener Testfälle. Diese Tests müssen sorgfältig ausgeführt, mit Screenshots dokumentiert und verständlich beschrieben werden. Auf diese Weise kann am Ende klar gezeigt werden, dass der Service korrekt funktioniert und alle Anforderungen erfüllt.

<br>

## 1.3 Was ist Nextcloud?
[Nextcloud](https://nextcloud.com/de/) ist eine Open-Source-Software für den Betrieb einer eigenen Cloud-Plattform. Sie ermöglicht es, Dateien, Kalender, Kontakte und weitere Daten zentral zu speichern, zu verwalten und mit anderen Benutzerinnen und Benutzern zu teilen. Im Gegensatz zu kommerziellen Cloud-Diensten wie Google Drive oder OneDrive wird Nextcloud auf einem eigenen Server betrieben, wodurch die volle Kontrolle über Daten und Zugriffe erhalten bleibt. 
<br><br>
<img src="./BilderDokumentation/Nextcloud.png" alt="Nextcloud" width="300">

<br>

## 1.4 Aufgabenverteilung
Wie sind wird überhaupt vorgegangen in diesem Projekt. Wir wollten bevor wird anfangen eine klare Aufgabenverteilung machen, sodass jeder genau weiss was er zu tun hat. Während Deon die zwei Initialscripts erstellt hat, haben Armin und Jan auf das deploy.sh konzentriert. 
<br> <br>
Bezüglich der Dokumentation haben wir nichts wirklich eine klare Verteilung gemacht. Wenn man Zeit hatte hat man an der Dokumentation gearbeitet. Jedoch haben wir uns auf eine Regel geeinigt. Wenn jemand zuhause etwas macht. Wird das zuerst immer besprochen. So konnten wir probleme bezüglich dem Pushen in git umgehen.

---
<br><br>

# 2. Vorgehen
## 2.1 Planung
Bevor wir mit dem Projekt begonnen haben, haben wir uns zunächst angeschaut, welche Cloud-Infrastruktur benötigt wird, um das Projekt zu realisieren. Wir haben uns für eine VPC entschieden. Die VPC ist über ein Internet Gateway mit dem Internet verbunden. Innerhalb der VPC befindet sich ein Public Subnet, in dem zwei EC2-Instanzen betrieben werden. Eine Instanz wird als Webserver verwendet, die andere Instanz dient als Datenbankserver. Die Kommunikation zwischen dem Webserver und dem Datenbankserver erfolgt innerhalb der VPC. Der Zugriff von aussen ist jedoch nur bis zum Webserver möglich.

<img src="./BilderDokumentation/AWS-Netzplan.png" alt="Nextcloud" width="500">

<br><br>

## 2.2 Git-Repo aufsetzen
Damit wir unser Projekt in einer Versionverwaltungs betreiben können, haben wir nach der Plannung angefangen das Git-Repository aufzusetzten. [Github](https://github.com/) ist ein Versionverwaltungs tool welches sich unserer Meinung nach sehr einfach bedienen lässt. Bevor uns also an das Scripten gesetzt haben, haben wir das Git-Repository aufgesetzt. Dafür haben wir diese Sache ausgefüllt:
<br><br>
<img src="./BilderDokumentation/GitRepo-Aufsetzten.png" alt="Nextcloud" width="500">
| Begriff | Beschreibung |
|--------|--------------|
| Repository name  | M346-Projekt |
| Description | Das ist das Git Repository von der Gruppe Armin Hujdur, Jan Speck und Deon Ramadani |
| Choose visibillity | public |
| Add READMEE | On |
| Add .gitignore | No .gitignore |
| Add license | No licence |

<br>
Nachdem wir das Git-Repository erstellt haben, konnten wird das Repository auf unsere Rechner Clonen
<br><br>

```
git clone https://github.com/deonramadani/M346-Projekt.git
```
So hatten wir ein fertiges Versionverwaltungssystem mitwelchem wir unsere Scripts bearbeiten und verwalten können.

<br><br>

## 2.3 Initial-Scripts
Nachdem wir die Versionsverwaltung eingerichtet haben, konnten wird endlich anfangen die Scripts zu erstellen. Angefangen hat Deon mit den Initial Scripts. Diese sind für das Infrastrukture as Code (IaC) zuständig. Mit dieser Methode konnten wir unsere Scripts in jeder Cloudumgebung direkt implementieren. In rahmen dieses Projektes mussten wird zwei Initialscripts erstellen. Eins für den [Webserver](/IaC/initial-webserver.sh) und eins für den [Datenbank-Server](/IaC/initial-db-server.sh). Angefangen habe ich mit dem Webserver Script. 
<br>

**Initial Webserver**

Damit Nextcloud erfolgreich auf dem Webserver laufen kann, musste ich folgende Packete installieren:

- Apache2
- PHP (Grundinstallation)
  - PHP
  - php-cli
  - libapache2-mod-php

- PHP-Erweiterungen
  - php-gd 

  - php-mbstring 

  - php-xml 

  - php-zip 

  - php-curl 

  - php-intl 

  - php-bcmath

  - php-gmp 

  - php-mysql 

Diese PHP Erweiterungen werden von Nextcloud benötigt um richtitg zu funtionieren. Neben den PHP Packeten habe ich noch wget und unzip installiert.
<br>

**Nextcloud nach /var/www/nextcloud verschieben**

Nachdem alle notwendigen Installationen fertig waren, habe ich begonnen, die Nextcloud-Dateien nach /var/www/nextcloud zu verschieben. Dieses Verzeichnis wird vom Apache-Webserver als Speicherort für Webanwendungen verwendet. Damit Apache die Nextcloud-Dateien ausliefern kann, müssen sie sich innerhalb dieses Verzeichnisses befinden. Durch das Verschieben der Dateien wird sichergestellt, dass Nextcloud über den Webserver erreichbar ist und korrekt ausgeführt werden kann.
<br>


**Rechte setzen**

Nachdem die Nextcloud-Dateien im richtigen Verzeichnis abgelegt wurden, habe ich die Dateirechte angepasst. Der Besitzer aller Dateien und Ordner wurde auf den Webserver-Benutzer www-data gesetzt, damit Apache auf die Nextcloud-Dateien zugreifen kann. Zusätzlich wurden die Zugriffsrechte für Ordner und Dateien eingeschränkt. Dadurch wird sichergestellt, dass Nextcloud korrekt funktioniert und gleichzeitig unnötige Zugriffe verhindert werden.
<br>

**Nexctloud als Startseite**

Damit Nextcloud direkt über die Server-URL erreichbar ist, wurde das DocumentRoot von Apache angepasst. Anstelle des Standardverzeichnisses /var/www/html wird nun das Verzeichnis /var/www/nextcloud verwendet. Dadurch lädt Apache beim Aufruf der Server-Adresse automatisch die Nextcloud-Anwendung.
<br>

**Directory-Konfiguration für Nextcloud**

Zum Schluss wurde eine zusätzliche Apache-Konfigurationsdatei für Nextcloud erstellt. In dieser wird festgelegt, dass der Zugriff auf das Nextcloud-Verzeichnis erlaubt ist und dass Apache die von Nextcloud benötigten .htaccess-Dateien auswerten darf. Diese Konfiguration ist notwendig, damit Nextcloud korrekt funktioniert und alle internen Einstellungen angewendet werden können.

**Apache neu laden**

Nachdem die Konfigurationsdatei für Nextcloud erstellt wurde, wird diese aktiviert, damit Apache die neuen Einstellungen berücksichtigt. Anschliessend wird der Apache-Webserver neu geladen, damit alle vorgenommenen Konfigurationsänderungen übernommen werden.

---
<br><br>

**Initial Datenbank-Server**

Damit Nextcloud seine Daten speichern kann, brauchen wir eine Datenbank. Auch diese wird auf der zweiten EC2 Instanz laufen. Dafür haben wir folgende Packete installisert:
 
-   MySQL Datenbank Server

Sobald die Installation abgeschlossen ist, wird der MySQL-Dienst gestartet und so eingerichtet, dass er beim Systemstart automatisch wieder hochfährt. Dadurch ist sichergestellt, dass die Datenbank immer verfügbar ist, auch nach einem Neustart des Servers.

**Datenbank und Benutzer erstellen**

Im nächsten Schritt wird die Datenbank für Nextcloud vorbereitet. Dazu wird eine Datenbank mit dem Namen nextcloud erstellt. Zusätzlich wird ein eigener Datenbankbenutzer nextcloud angelegt und mit einem Passwort versehen. Dieser Benutzer erhält alle benötigten Rechte auf die Nextcloud-Datenbank, damit Nextcloud später Daten speichern und lesen kann. Anschliessend werden die Änderungen mit FLUSH PRIVILEGES übernommen.

**Remote-Zugriff erlauben (bind-address anpassen)**

Damit der Webserver eine Verbindung zur Datenbank herstellen kann, wird danach der Remote-Zugriff erlaubt. Dafür wird in der MySQL-Konfiguration die bind-address so angepasst, dass MySQL nicht nur lokal, sondern auch über das Netzwerk erreichbar ist. Damit diese Änderung aktiv wird, wird der MySQL-Dienst neu gestartet.

**Verbindungsoptionen für Nextcloud ausgeben**

Zum Schluss wird die interne IP-Adresse des Datenbankservers ermittelt. Diese IP-Adresse wird zusammen mit dem Datenbanknamen, dem Benutzer und dem Passwort in der Konsole ausgegeben. Diese Angaben werden später im Nextcloud-Installationsassistenten benötigt, um die Verbindung zur Datenbank korrekt einzutragen.

---
<br><br>

## 2.4 deploy.sh 
Das Skript deploy.sh bildet das zentrale Element der Automatisierung dieses Projekts. Es ist verantwortlich für den vollständigen Aufbau der AWS-Infrastruktur sowie für das Starten der beiden EC2-Instanzen, welche als Webserver und Datenbankserver dienen. Die eigentliche Installation und Konfiguration von Nextcloud und MySQL erfolgt über sogenannte User-Data-Skripte, die beim Start der Instanzen automatisch ausgeführt werden.

**Vorbereitung und Konfiguration**

Zu Beginn des Skripts wird mit set -e sichergestellt, dass das Deployment sofort abgebrochen wird, sobald ein Fehler auftritt. Dadurch wird verhindert, dass eine unvollständige oder fehlerhafte Infrastruktur erstellt wird.

Anschliessend wird die AWS-Region automatisch aus der CloudShell-Konfiguration gelesen. Diese Information ist notwendig, damit alle AWS-CLI-Befehle in der korrekten Region ausgeführt werden. Zusätzlich werden zentrale Variablen definiert, darunter der Projektname, der IP-Adressbereich der VPC, das Public Subnet sowie der verwendete Instanztyp.

Damit die User-Data-Skripte korrekt geladen werden können, werden die Dateipfade relativ zur deploy.sh ermittelt. Das Skript prüft danach, ob die Dateien IaC/initial-webserver.sh und IaC/initial-db-server.sh vorhanden sind. Falls eine dieser Dateien fehlt, wird das Deployment abgebrochen und eine Fehlermeldung ausgegeben.

**Auswahl des Betriebssystems**

Für beide EC2-Instanzen wird eine feste Ubuntu 22.04 AMI für die Region us-east-1 (N. Virginia) verwendet. Durch die feste AMI-ID wird sichergestellt, dass alle Instanzen auf dem gleichen, getesteten Betriebssystem basieren und sich identisch verhalten.

**Aufbau der Netzwerkstruktur**

Im nächsten Schritt erstellt das Skript die komplette Netzwerkumgebung in AWS:

Zuerst wird eine Virtual Private Cloud (VPC) mit dem Adressbereich 10.0.0.0/16 erstellt. Zusätzlich werden DNS-Unterstützung und DNS-Hostnames aktiviert, um eine korrekte Namensauflösung innerhalb der VPC zu ermöglichen.

Danach wird ein Internet Gateway erstellt und mit der VPC verbunden. Dieses Gateway erlaubt den Instanzen im Public Subnet den Zugriff auf das Internet, was für Updates und die Installation von Software notwendig ist.

Anschliessend wird ein Public Subnet mit dem Adressbereich 10.0.1.0/24 angelegt. Dieses Subnet ist so konfiguriert, dass neu gestartete Instanzen automatisch eine öffentliche IPv4-Adresse erhalten.

Damit der Internetzugang funktioniert, wird eine Route Table erstellt und mit einer Default-Route (0.0.0.0/0) zum Internet Gateway versehen. Diese Route Table wird anschliessend dem Public Subnet zugewiesen.

**Security Groups**

Zur Absicherung der Infrastruktur werden zwei getrennte Security Groups erstellt:

Die Webserver Security Group erlaubt eingehenden Datenverkehr auf den Ports 80 (HTTP) und 443 (HTTPS) aus dem Internet. Dadurch kann die Nextcloud-Instanz später über einen Webbrowser erreicht werden.

Die Datenbank Security Group erlaubt Verbindungen auf Port 3306 (MySQL) ausschliesslich aus dem internen VPC-Netz. Dadurch ist die Datenbank nicht direkt aus dem Internet erreichbar, sondern nur für den Webserver innerhalb der VPC zugänglich.

**Start der EC2-Instanzen**

Nach der Netzwerkkonfiguration startet das Skript zwei EC2-Instanzen:

Die Webserver-Instanz wird mit der Webserver Security Group gestartet und erhält das User-Data-Skript initial-webserver.sh. Dieses Skript installiert Apache, PHP und Nextcloud und konfiguriert den Webserver so, dass Nextcloud direkt über die Serveradresse erreichbar ist.

Die Datenbank-Instanz wird mit der Datenbank Security Group gestartet und erhält das User-Data-Skript initial-db-server.sh. Dieses Skript installiert MySQL, erstellt die notwendige Datenbank sowie den Benutzer und konfiguriert den Zugriff für den Webserver.

Beide Instanzen werden mit aussagekräftigen Tags versehen, um sie in der AWS-Management-Console eindeutig identifizieren zu können.

**Abschluss und Ausgabe der Zugangsdaten**

Das Skript wartet anschliessend, bis beide Instanzen den Status running erreicht haben. Danach werden automatisch die öffentliche IP-Adresse des Webservers sowie die private IP-Adresse des Datenbankservers ausgelesen.

Zum Schluss gibt das Skript alle relevanten Informationen in der Konsole aus. Dazu gehören die URL für den Zugriff auf Nextcloud sowie die benötigten Datenbank-Zugangsdaten. Diese Angaben werden im Nextcloud-Installationsassistenten verwendet, um die Installation abzuschliessen.
<br><br>

# 3. Testfälle

<br>

## 3.1 Testfall 1

<br>

## 3.2 Testfall 2

<br>

## 3.3 Testfall 3

<br><br>

# 4. Reflexion

<br><br>

# 5. Quellen
